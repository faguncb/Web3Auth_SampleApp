<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Web3Auth Demo</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com?v=3"></script>
    <style>
        /* A simple loader for showing a busy state */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

<!-- 2. Ethers.js: To interact with the blockchain -->
<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<!-- 3. Web3Auth Modal SDK: The main library -->
<script src="web3auth-modal.js"></script>

<script>
    // --- 0. SCRIPT SETUP ---
    console.log("Starting Web3Auth Demo...");
    
    // Test if scripts loaded
    setTimeout(() => {
        console.log("After 2 seconds:");
        console.log("Ethers available:", typeof ethers !== 'undefined');
        console.log("Modal available:", typeof window.Modal !== 'undefined');
        console.log("Web3Auth available:", typeof window.Modal?.Web3Auth !== 'undefined');
    }, 2000);

    function initializeApp() {
        let Web3Auth;
        
        try {
            if (window.Modal && window.Modal.Web3Auth) {
                Web3Auth = window.Modal.Web3Auth;
                console.log("Web3Auth found!");
            } else {
                console.error("Web3Auth not available");
                console.log("Available window.Modal:", window.Modal);
                console.log("Available window.Modal keys:", window.Modal ? Object.keys(window.Modal) : 'undefined');
                alert("Failed to load Web3Auth library. Please refresh the page and try again.");
                return;
            }
        } catch (error) {
            console.error("Failed to load Web3Auth:", error);
            alert("Failed to load Web3Auth library. Please refresh the page and try again.");
            return;
        }

        // --- 1. CONFIGURATION ---
        const clientId = "BMPMZSSZyj5VGGq8DwDZ5RUQDmMWKzzRLNdFbZRjkQAe0Pz-yK_CKAN4Dx0VMaAm1ArT392kzBw0q6cQugbQGa0"; // Your Client ID from dashboard.web3auth.io
        const web3AuthNetwork = "sapphire_devnet"; // Web3Auth network
        const chainConfig = {
            chainNamespace: "eip155",
            chainId: "0xaa36a7", // Sepolia Testnet
            rpcTarget: "https://rpc.sepolia.org",
            displayName: "Sepolia Testnet",
            blockExplorer: "https://sepolia.etherscan.io",
            ticker: "ETH",
            tickerName: "Ethereum",
        };

        // Global variables to hold SDK instances
        let web3auth = null;
        let provider = null; // This will be the EIP-1193 provider from Web3Auth

        // Get DOM elements
        const loginView = document.getElementById("login-view");
        const appView = document.getElementById("app-view");
        const loginBtn = document.getElementById("login-btn");
        const loginBtnText = document.getElementById("login-btn-text");
        const loginLoader = document.getElementById("login-loader");
        const logoutBtn = document.getElementById("logout-btn");
        const signMsgBtn = document.getElementById("sign-message-btn");
        const userInfoDiv = document.getElementById("user-info");
        const consoleEl = document.getElementById("console");

        // --- 2. INITIALIZATION ---

        // Runs on page load
        async function main() {
            try {
                log("Initializing Web3Auth...");
                web3auth = new Web3Auth({
                    clientId,
                    web3AuthNetwork,
                    chainConfig,
                    uiConfig: {
                        theme: "light",
                        loginMethodsOrder: ["google", "facebook", "twitter"],
                        appName: "Web3Auth Demo",
                    },
                });

                // This initializes the modal. It doesn't log the user in.
                await web3auth.initModal();
                log("Web3Auth Initialized successfully!");

                // If a user was already logged in, their provider will be available
                if (web3auth.provider) {
                    provider = web3auth.provider;
                    log("Found existing session, restoring user state...");
                    updateUI(true); // Show the app view
                    getUserDetails(); // Fetch their details
                } else {
                    log("No existing session found. Ready for login.");
                }
            } catch (error) {
                console.error(error);
                log(`Error initializing: ${error.message}`);
            }
        }

        // --- 3. LOGIN & LOGOUT ---

        async function login() {
            if (!web3auth) {
                log("Web3Auth not initialized yet.");
                return;
            }

            try {
                setLoginBusy(true, "Logging in...");

                // This is the core function that opens the modal
                provider = await web3auth.connect();

                log("Login successful!");
                updateUI(true); // Show the app view
                getUserDetails(); // Fetch wallet details

            } catch (error) {
                console.error(error);
                log(`Login failed: ${error.message}`);
            } finally {
                setLoginBusy(false);
            }
        }

        async function logout() {
            if (!web3auth) {
                log("Web3Auth not initialized.");
                return;
            }

            try {
                log("Logging out...");
                await web3auth.logout();
                provider = null; // Clear the provider

                log("Logged out.");
                updateUI(false); // Show the login view
                userInfoDiv.innerHTML = ""; // Clear user info

            } catch (error) {
                console.error(error);
                log(`Logout failed: ${error.message}`);
            }
        }

        // --- 4. WEB3 ACTIONS (with Ethers.js) ---

        async function getUserDetails() {
            if (!provider) {
                log("Provider not available. Please log in first.");
                return;
            }
            
            if (!web3auth) {
                log("Web3Auth not initialized.");
                return;
            }
            
            try {
                log("Fetching user details...");

                // 1. Wrap the Web3Auth provider with Ethers.js
                const ethersProvider = new ethers.providers.Web3Provider(provider);

                // 2. Get the wallet's signer object
                const signer = ethersProvider.getSigner();

                // 3. Get social login info (email, name, etc.)
                const userInfo = await web3auth.getUserInfo();

                // 4. Get the wallet address
                const address = await signer.getAddress();

                // 5. Get the balance (in Wei) and format it to ETH
                const balanceWei = await ethersProvider.getBalance(address);
                const balanceEth = ethers.utils.formatEther(balanceWei);

                // 6. Display the info
                userInfoDiv.innerHTML = `
                <p><strong>Email:</strong> ${userInfo.email || 'N/A'}</p>
                <p><strong>Name:</strong> ${userInfo.name || 'N/A'}</p>
                <p class="mt-2"><strong>Wallet Address:</strong></p>
                <p class="font-mono">${address}</p>
                <p class="mt-2"><strong>Sepolia Balance:</strong> ${parseFloat(balanceEth).toFixed(5)} ETH</p>
            `;
                log("User details fetched successfully.");
            } catch (error) {
                console.error(error);
                log(`Error fetching details: ${error.message}`);
            }
        }

        async function signMessage() {
            if (!provider) {
                log("Provider not available.");
                return;
            }
            try {
                log("Signing test message...");
                const ethersProvider = new ethers.providers.Web3Provider(provider);
                const signer = ethersProvider.getSigner();

                const originalMessage = "Hello from Web3Auth!";

                // This will open a popup from Web3Auth asking the user to confirm
                const signature = await signer.signMessage(originalMessage);

                log(`Message: "${originalMessage}"`);
                log(`Signature: ${signature}`);
            } catch (error) {
                console.error(error);
                log(`Error signing message: ${error.message}`);
            }
        }

        // --- 5. HELPER FUNCTIONS ---

        function updateUI(isLoggedIn) {
            if (isLoggedIn) {
                loginView.classList.add("hidden");
                appView.classList.remove("hidden");
            } else {
                loginView.classList.remove("hidden");
                appView.classList.add("hidden");
            }
        }

        function setLoginBusy(isBusy, text = "Log In") {
            if (isBusy) {
                loginBtnText.classList.add("hidden");
                loginLoader.classList.remove("hidden");
                loginBtn.disabled = true;
            } else {
                loginBtnText.innerText = text;
                loginBtnText.classList.remove("hidden");
                loginLoader.classList.add("hidden");
                loginBtn.disabled = false;
            }
        }

        function log(message) {
            console.log(message);
            consoleEl.innerHTML = `${message}\n` + consoleEl.innerHTML;
        }

        // --- 6. ATTACH EVENT LISTENERS ---

        loginBtn.addEventListener("click", login);
        logoutBtn.addEventListener("click", logout);
        signMsgBtn.addEventListener("click", signMessage);

        // Start the application!
        main();
    }

    // Initialize the app after a delay to ensure scripts are loaded
    setTimeout(() => {
        console.log("Initializing app after delay...");
        initializeApp();
    }, 3000);

</script>

<div class="container mx-auto max-w-lg mt-10 p-6 bg-white rounded-xl shadow-lg">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Web3Auth Social Login Demo</h1>

    <!-- Logged Out View -->
    <div id="login-view">
        <p class="text-center text-gray-600 mb-4">
            Log in with your social account to create a non-custodial wallet.
        </p>
        <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
            <span id="login-btn-text">Log In</span>
            <div id="login-loader" class="loader hidden"></div>
        </button>
    </div>

    <!-- Logged In View -->
    <div id="app-view" class="hidden">
        <!-- User info will be populated here -->
        <div id="user-info" class="p-4 bg-gray-50 rounded-lg mb-4 text-sm break-words"></div>

        <button id="sign-message-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mb-3 transition duration-300">
            Sign a Test Message
        </button>
        <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
            Log Out
        </button>

        <div class="mt-4">
            <h3 class="font-semibold text-gray-700">Console:</h3>
            <pre id="console" class="bg-gray-900 text-white text-xs rounded-lg p-4 h-48 overflow-y-auto mt-2">App not initialized.</pre>
        </div>
    </div>
</div>

<!-- SDKs and our app logic will go here -->

</body>
</html>
